---
# Configure and start the VPN server
- hosts: vpnserver
  roles:
    - vpnserver
    - caserver # This role can be removed if the certificates are copied from a different machine
  become: true
  tasks:
    - name: Copy server certificates and keys
      copy:
        src: "{{ item }}"
        dest: "{{ vpn_config_dir }}"
        owner: root
        group: root
        mode: 0600
        remote_src: true
      with_items:
        - "{{ easyrsa_dir }}/pki/ca.crt"
        - "{{ easyrsa_dir }}/pki/dh.pem"
        - "{{ easyrsa_dir }}/pki/issued/server.crt"
        - "{{ easyrsa_dir }}/pki/private/server.key"
        - "{{ easyrsa_dir }}/pki/ta.key"

    - name: Install packages
      apt:
        name: ["openvpn", "ufw"]
        state: latest

    - name: Configure openvpn server
      template:
        src: server.conf.j2
        dest: "{{ vpn_config_dir }}/server.conf"
        owner: root
        group: root
        mode: 0600

    - name: Start openvpn server
      service:
        name: openvpn-server@server
        state: started
        enabled: true
