---
- hosts: vpnserver
  vars:
    easyrsa_install_path: "/opt"
    easyrsa_dir: "{{ easyrsa_install_path }}/EasyRSA"
    easyrsa_bin: "{{ easyrsa_dir }}/easyrsa"

  environment:
    EASYRSA_BATCH: "true"
  become: true

  tasks:
    - name: Install dependencies
      apt:
        name: ["openvpn", "ufw", "curl"]
        state: latest

    - name: Install EasyRSA
      shell: |
        easyrsa_version=$(curl --silent "https://api.github.com/repos/OpenVPN/easy-rsa/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
        easyrsa_url="https://github.com/OpenVPN/easy-rsa/releases/download/v${easyrsa_version}/EasyRSA-${easyrsa_version}.tgz"
        curl -so /tmp/easyrsa.tgz -L "$easyrsa_url"
        tar -xzf /tmp/easyrsa.tgz -C {{ easyrsa_install_path }}
        mv {{ easyrsa_install_path }}/EasyRSA-${easyrsa_version} {{ easyrsa_install_path }}/EasyRSA
      args:
        creates: "{{ easyrsa_bin }}"

    - name: Initialize PKI
      command: "{{ easyrsa_bin }} init-pki"
      args:
        chdir: "{{ easyrsa_dir }}"
        creates: "{{ easyrsa_dir }}/pki"

    - name: Build CA
      command: "{{ easyrsa_bin }} build-ca nopass"
      args:
        chdir: "{{ easyrsa_dir }}"
        creates: "{{ easyrsa_dir }}/pki/private/ca.key"

    - name: Generate DH params
      command: "{{ easyrsa_bin }} gen-dh"
      args:
        chdir: "{{ easyrsa_dir }}"
        creates: "{{ easyrsa_install_path }}/pki/dh.pem"
# - name: Generate server certificate
